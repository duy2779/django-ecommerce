{% extends 'store/base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{% static 'styles/checkout_style.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'styles/cart_responsive.css' %}">
<div class="checkout_section">
    <div class="container">
        <div class="row">
            <div class="col-lg-6">
                <div class="box-element" id="form-wrapper">
                    <h3>Thông tin khách hàng</h3>
                    <hr>
                    <form id="form">
                        {% csrf_token %}
                            <div class="d-flex flex-md-row flex-column justify-content-between align-items-between">
                                <input required class="form-control input_field" type="text" name="name" placeholder="Tên người nhận" value="{{order.customer.name}}">
                                <input required class="form-control input_field" type="phone" name="phone" placeholder="Số điện thoại" value="{{order.customer.phone}}">
                            </div>
                            <div>
                                <input required class="form-control input_field_line" type="email" name="email" placeholder="Email" value="{{order.customer.email}}">
                            </div>
                            <div>
                                <input required class="form-control input_field_line" type="text" name="address" placeholder="Địa chỉ">
                            </div>
                            <div class="form-check ml-4">
                                <input class="form-check-input" type="radio" name="payment" id="exampleRadios1" value="option1" checked>
                                <label class="form-check-label" for="exampleRadios1">
                                  Thanh toán qua thẻ tín dụng
                                </label>
                              </div>
                              <div class="form-check ml-4">
                                <input class="form-check-input" type="radio" name="payment" id="exampleRadios2" value="option2">
                                <label class="form-check-label" for="exampleRadios2">
                                  Thanh toán khi nhận hàng
                                </label>
                              </div>
                        <hr>
                        <input id="make-payment" class="btn btn-success btn-block" type="submit" value="Đặt hàng">
                    </form>
                </div>
                <br>
            </div>
            <div class="col-lg-6">
                <div class="box-element">
                    <h3>Thông tin đơn hàng</h3>
                    <hr>
                    {% for item in items %}
                    <div>
                        <ul class="checkout_list">
                            <li class="checkout_item clearfix">
                                <div class="checkout_item_image"><img src="{{ item.product.imageURL }}" alt=""></div>
                                <div class="checkout_item_info d-flex flex-md-row flex-column justify-content-between">
                                    <div class="checkout_item_name checkout_info_col">

                                        <div class="checkout_item_text">MacBook Air 13</div>
                                    </div>
                                    <div class="checkout_item_quantity cart_info_col">

                                        <div class="checkout_item_text">x{{ item.quantity }}</div>
                                    </div>
                                    <div class="checkout_item_total cart_info_col">

                                        <div class="checkout_item_text">${{ item.get_total|intcomma }}<sup>đ</sup></div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                    {% endfor %}
                    <div class="order_total">
                        <div class="order_total_content text-md-right">
                            <div class="order_total_title">Tổng tiền:</div>
                            <div class="order_total_amount">${{ order.get_cart_total|intcomma }}<sup>đ</sup></div>
                        </div>
                    </div>
                    <div class="checkout_buttons">
                        <a  class="btn btn-outline-dark" href="{% url 'cart' %}">&#x2190; Quay lại giỏ hàng</a>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var total = '{{order.get_cart_total}}'

            var form = document.getElementById('form')
            //fix token misssing
            csrftoken = form.getElementsByTagName("input")[0].value
            console.log('Newtoken:', form.getElementsByTagName("input")[0].value)

            form.addEventListener('submit', function(e){
                e.preventDefault()
                submitFormData()
            })

            function submitFormData(){
                console.log('Form submitted...')
                var formData = {
                    'name':null,
                    'email':null,
                    'phone':null,
                    'address':null,
                    'payment':null,
                    'total':total
                }

                formData.name = form.name.value
                formData.email = form.email.value
                formData.phone = form.phone.value
                formData.address = form.address.value
                formData.payment =form.payment.value

                var url = '/process_order/'
                fetch(url,{
                    method: 'POST',
                    header:{
                        'Content-Type':'applicaiton/json',
	    			    'X-CSRFToken':csrftoken,
                    },
                    body:JSON.stringify({'form':formData})
                })
                .then((response) => response.json())
                .then((data) => {
                    console.log('success:',data);
                    alert('Đặt hàng thành công');

                    cart= {}
                    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/"

                    window.location.href = "{% url 'index' %}"
                })
            }

        </script>
    </div>
</div>
{% endblock content %}